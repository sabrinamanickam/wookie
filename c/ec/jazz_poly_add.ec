require import AllCore IntDiv CoreMap List Distr.
from Jasmin require import JModel_x86.
import SLH64.


require import Array6 Array24 Array25 Array1024.
require import WArray192 WArray200 WArray768 WArray2048.

abbrev KECCAK_A_JAGGED = Array25.of_list witness [W64.of_int 0; W64.of_int 4;
W64.of_int 5; W64.of_int 6; W64.of_int 7; W64.of_int 10; W64.of_int 24;
W64.of_int 13; W64.of_int 18; W64.of_int 23; W64.of_int 8; W64.of_int 16;
W64.of_int 25; W64.of_int 22; W64.of_int 15; W64.of_int 11; W64.of_int 12;
W64.of_int 21; W64.of_int 26; W64.of_int 19; W64.of_int 9; W64.of_int 20;
W64.of_int 17; W64.of_int 14; W64.of_int 27].


abbrev KECCAK_RHOTATES_RIGHT = Array6.of_list witness [W256.of_int 144373339913893657577751063007562604548177214458152943091773;
W256.of_int 232252764209307188274174373867837442080505530800860351692863;
W256.of_int 156927543384667019098616994515559168111335794127330162507795;
W256.of_int 351517697181654122777866749001917765472957616589092975280182;
W256.of_int 276192476357013953622045746931053922384479139705868246843454;
W256.of_int 313855086769334038206421612937983674734430261968315659321364].


abbrev KECCAK_RHOTATES_LEFT = Array6.of_list witness [W256.of_int 257361171150853911329517531560668107745210100483895842570243;
W256.of_int 169481746855440380633094220700393270212881784141188433969153;
W256.of_int 244806967680080549808651600052671544182051520814718623154221;
W256.of_int 50216813883093446129401845566312946820429698352955810381834;
W256.of_int 125542034707733615285222847637176789908908175236180538818562;
W256.of_int 87879424295413530700846981630247037558957052973733126340652].


abbrev KECCAK_IOTAS = Array24.of_list witness [W256.of_int 6277101735386680764176071790128604879584176795969512275969;
W256.of_int 206504092890751023779864409751650843328560248233805014854828162;
W256.of_int (-57896044618657891154337237002533387566728630465883811983015055433200855646070);
W256.of_int (-57896044605177918687001956587831074660851270707671256656745893357814858874880);
W256.of_int 206560586806369503906741994397762000772476505824968740465311883;
W256.of_int 13479973339852421633450939126351338586088633588469736715148203130881;
W256.of_int (-57896044605177917877255832722949256082138009781081227190387086677747775274879);
W256.of_int (-57896044618657891964083360867415206145441891392473841449373862113267939246071);
W256.of_int 866240039483361945456297907037747473382616397843792694083722;
W256.of_int 853685836012588583927945763457490263623448044251853669531784;
W256.of_int 13480179078138900667299665761280331841242166839448401411882560290825;
W256.of_int 13479973396346337251931066003935984697246077504727327878873813614602;
W256.of_int 13480179894162126267568165104169664557960801185391384887919156166795;
W256.of_int (-57896044618658096836129800417901987324072977609879901317736128966209602322293);
W256.of_int (-57896044618657891160614338737920068330904702256012416862599232229170367922039);
W256.of_int (-57896044618657892001745971279735290730498322133245470726878922889085012901885);
W256.of_int (-57896044618657892008023073015121971494674393923374075606463099685054525177854);
W256.of_int (-57896044618658096905177919507155475730009767301294554993162073721874237357952);
W256.of_int 205750840682504622088163281136835410743010147018288673381711882;
W256.of_int (-57896044605178124312300604384719547540610971740509902075209375727097995067382);
W256.of_int (-57896044605177917877255832722949256082138009781081227190387086677747775274879);
W256.of_int (-57896044618657891217108254356400195208489348367169860778856823392895978405760);
W256.of_int 13479973339852421633450939126351338586088633588469736715148203130881;
W256.of_int (-57896044605177918636785142704737628547442696386642417620072478990058760667128)].


module M = {
  proc to_stack_array_16_N (sr:W16.t Array1024.t, pr:W64.t) : W16.t Array1024.t = {
    
    var i:W64.t;
    
    i <- (W64.of_int 0);
    
    while ((i \ult (W64.of_int 1024))) {
      sr.[(W64.to_uint i)] <-
      (loadW16 Glob.mem (W64.to_uint (pr + (i * (W64.of_int 2)))));
      i <- (i + (W64.of_int 1));
    }
    return (sr);
  }
  
  proc from_stack_array_16_N (sr:W16.t Array1024.t, pr:W64.t) : W64.t = {
    
    var i:W64.t;
    
    i <- (W64.of_int 0);
    
    while ((i \ult (W64.of_int 1024))) {
      Glob.mem <-
      storeW16 Glob.mem (W64.to_uint (pr + (i * (W64.of_int 2)))) (sr.[(W64.to_uint i)]);
      i <- (i + (W64.of_int 1));
    }
    return (pr);
  }
  
  proc poly_add (r_coeffs:W16.t Array1024.t, a_coeffs:W16.t Array1024.t,
                 b_coeffs:W16.t Array1024.t) : W16.t Array1024.t = {
    
    var i:W64.t;
    var temp:W16.t;
    
    i <- (W64.of_int 0);
    
    while ((i \ult (W64.of_int 1024))) {
      temp <- a_coeffs.[(W64.to_uint i)];
      temp <- (temp + b_coeffs.[(W64.to_uint i)]);
      r_coeffs.[(W64.to_uint i)] <- temp;
      i <- (i + (W64.of_int 1));
    }
    return (r_coeffs);
  }
  
  proc jazz_poly_add (pr:W64.t, pa:W64.t, pb:W64.t) : unit = {
    
    var sa:W16.t Array1024.t;
    var sb:W16.t Array1024.t;
    var sr:W16.t Array1024.t;
    var r:W16.t Array1024.t;
    var a:W16.t Array1024.t;
    var b:W16.t Array1024.t;
    a <- witness;
    b <- witness;
    r <- witness;
    sa <- witness;
    sb <- witness;
    sr <- witness;
    sa <@ to_stack_array_16_N (sa, pa);
    sb <@ to_stack_array_16_N (sb, pb);
    r <- sr;
    a <- sa;
    b <- sb;
    r <@ poly_add (r, a, b);
    sr <- r;
    pr <@ from_stack_array_16_N (sr, pr);
    return ();
  }
}.

